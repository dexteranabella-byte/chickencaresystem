<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Growth Tracking</title>
    <!-- ======= Styles ====== --><link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        /* This minimal style is to make the video act like a "live feed" */
        .live-feed-container {
            padding: 20px; /* Adjust as needed */
            margin-top: 20px; /* Add some space below the topbar */
        }

        /* --- NEW: Style for the centered content --- */
        .growthCamera .centered-header {
            text-align: center; /* This centers everything inside it */
        }
        
        .growthCamera .datetime-local {
            font-size: 1.1em; /* Smaller than the title */
            color: #555; /* A dark grey, not as bold as black */
            margin-bottom: 5px; /* Small space between timestamp and title */
        }

        .growthCamera h1 {
            font-size: 2.5em; /* Or match your old h1 style */
            font-weight: 700;
            color: black; /* As requested */
            margin-bottom: 20px; /* Space between title and video */
            margin-top: 5px; /* Added small space above title */
        }
        /* --- END NEW --- */


        /* This class name is kept for consistency with your design */
        .gif-wrapper {
            position: relative; /* Set to relative to allow absolute positioning inside */
            width: 100%;
            max-width: 900px; /* Adjust as needed */
            margin: 0 auto;
            background: #000; /* Black background to mimic a video player */
            border-radius: 12px; /* Matches modern aesthetics */
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        /* This CSS rule is updated from 'img' to 'video' */
        .gif-wrapper video {
            width: 100%;
            height: auto;
            display: block;
            /* This makes the video non-clickable and non-interactive */
            pointer-events: none;
        }

        /* You might need to adjust .main.active .topbar's positioning if the new title pushes it */
        .main.active .topbar {
            left: 110px; /* Example adjustment, check your original .main.active .topbar styles */
            width: calc(100% - 110px); /* Example adjustment */
        }

        /* Further adjustments for monitor-container and image-container for better spacing */
        .monitor-container, #image-container {
            margin-top: 70px; /* Give more space below the video feed */
        }

        .growthTable {
            margin-top: 50px; /* Add space between elements */
        }
    </style>
</head>
<body>

    <!-- =============== Navigation ================ --><div class="container">
        <div class="navigation">
            <ul>
                <li>
                    <a href="#">
                        <span class="icon">
                            <img src="{{ url_for('static', filename='imgs/CC.png') }}">
                        </span>
                        <span class="title1">Chick Care</span>
                    </a>
                </li>

                <li>
                    <a href="/main_dashboard">
                        <span class="icon">
                            <ion-icon name="reorder-four-outline"></ion-icon>
                        </span>
                        <span class="title">Dashboard</span>
                    </a>
                </li>

                <!-- Set this item as active --><li class="active">
                    <a href="/webcam">
                        <span class="icon">
                            <ion-icon name="stats-chart-outline"></ion-icon>
                        </span>
                        <span class="title">Growth Tracking</span>
                    </a>
                </li>

                <li>
                    <a href="/feeding">
                        <span class="icon">
                            <ion-icon name="layers-outline"></ion-icon>
                        </span>
                        <span class="title">Supplies Stock</span>
                    </a>
                </li>

                <li>
                    <a href="/environment">
                        <span class="icon">
                            <ion-icon name="cloudy-outline"></ion-icon>
                        </span>
                        <span class="title">Environment</span>
                    </a>
                </li>

                <li>
                    <a href="/dashboard">
                        <span class="icon">
                            <ion-icon name="notifications-circle-outline"></ion-icon>
                        </span>
                        <span class="title">Notifications</span>
                    </a>
                </li>

                <li>
                    <a href="/sanitization">
                        <span class="icon">
                            <ion-icon name="water-outline"></ion-icon>
                        </span>
                        <span class="title">Sanitization</span>
                    </a>
                </li>

                <!-- Only show "Manage Users" if the logged-in user is an admin -->{% if session['user_role'] == 'admin' %}
                <li>
                    <a href="/manage_users">
                        <span class="icon">
                            <ion-icon name="people-outline"></ion-icon>
                        </span>
                        <span class="title">Manage Users</span>
                    </a>
                </li>
                {% endif %}

                <li>
                    <a href="/report">
                        <span class="icon">
                            <ion-icon name="file-tray-stacked-outline"></ion-icon>
                        </span>
                        <span class="title">Report</span>
                    </a>
                </li>

                <li>
                    <!-- Corrected logout link --><a href="{{ url_for('logout') }}">
                        <span class="icon">
                            <ion-icon name="log-out-outline"></ion-icon>
                        </span>
                        <span class="title">Sign Out</span>
                    </a>
                </li>
            </ul>
        </div>

        <!-- ========================= Main ==================== --><div class="main">
            <div class="topbar">
                <div class="toggle">
                    <ion-icon name="menu-outline"></ion-icon>
                </div>

                <!-- --- FIX: Added empty datetime div as a spacer to fix top bar layout --- -->
                <div class="datetime" style="visibility: hidden;"></div>

                <div class="iconn" onclick="toggleNotifi()">
                    <img src="{{ url_for('static', filename='imgs/bell.png') }}" alt=""> <span id="notificationCount">0</span>
                </div>
                <div class="notifi-box" id="box">
                    <h2>Notifications <span id="notificationCount1">0</span></h2>
                <div class="notifi-item">

                    <div class="text" id="notificationItems">

                    </div>
                </div>


                </div>


                <div class="user">
                    <img src="{{ url_for('static', filename='imgs/admin.jpg') }}" alt="">
                </div>
            </div>

        <!-- ========================= Growth Monitoring ==================== -->
        <div class="growthCamera">
            
            <!-- NEW: Wrapper to center timestamp and title -->
            <div class="centered-header">
                <!-- NEW: Datetime is now here -->
                <div class="datetime-local">
                    <span id="displayDateTime"></span>
                </div>

                <!-- Title is here, inside the centered wrapper -->
                <h1>Growth Tracking</h1>
            </div>

            <div class="gif-wrapper">
                <video src="{{ url_for('static', filename='imgs/Camera is loading.mp4') }}" 
                       autoplay 
                       loop 
                       muted 
                       playsinline 
                       oncontextmenu="return false;" 
                       disablepictureinpicture 
                       controlsList="nodownload">
                    Your browser does not support the video tag.
                </video>
            </div>

        </div>

            <!-- Removed these br tags, as margin-top in CSS is preferred for spacing --><div class="monitor-container">
                <!-- Existing Weight Monitoring --><div class="monitor-section">
                    <p>Weight</p>
                    <div class="weight" id="weight"></div>
                </div>

                <!-- Additional Weight Monitoring Sections --><div class="monitor-section">
                    <p>Weight</p>
                    <div class="weight" id="weight2"></div>
                </div>

                <div class="monitor-section">
                    <p>Weight</p>
                    <div class="weight" id="weight3"></div>
                </div>

                <div class="monitor-section">
                    <p>Weight</p>
                    <div class="weight" id="weight4"></div>
                </div>

                <div class="monitor-section">
                    <p>Weight</p>
                    <div class="weight" id="weight5"></div>
                </div>

                <div class="monitor-section">
                    <p>Weight</p>
                    <div class="weight" id="weight6"></div>
                </div>
            </div>

            <!--
                FIX: Added data- attributes to hold the server-rendered URLs.
                Used single quotes for the Jinja expression as is best practice.
            -->
            <div id="image-container" 
                 style="max-width: 1500px; margin: 0 auto; text-align: center; padding: 20px; border: 2px solid #ddd; border-radius: 15px; box-shadow: 0 0 15px rgba(0, 0, 0, 0.2); position: relative; top: 50px;"
                 data-list-url='{{ url_for("get_image_list") }}'
                 data-shots-url='{{ url_for("static", filename="shots/") }}'>
                
                <h1 style="color: #333; font-size: 28px; margin-bottom: 20px;">Poultry Images</h1>

                <div style="position: relative; overflow: hidden;">
                    <div style="display: flex; align-items: center; justify-content: space-between; position: relative;">
                        <img id="current-image-1" alt="Current Image" style="max-width: 30%; height: auto; border: 2px solid #ddd; border-radius: 15px; box-shadow: 0 0 15px rgba(0, 0, 0, 0.2); margin: 0 10px;">
                        <img id="current-image-2" alt="Current Image" style="max-width: 30%; height: auto; border: 2px solid #ddd; border-radius: 15px; box-shadow: 0 0 15px rgba(0, 0, 0, 0.2); margin: 0 10px;">
                        <img id="current-image-3" alt="Current Image" style="max-width: 30%; height: auto; border: 2px solid #ddd; border-radius: 15px; box-shadow: 0 0 15px rgba(0, 0, 0, 0.2); margin: 0 10px;">
                    </div>

                    <!-- Buttons below images --><div style="display: flex; justify-content: center; margin-top: 10px;">
                        <button onclick="changeImage(-1)" style="background-color: #4285f4; color: white; padding: 10px 20px; margin: auto; border: none; border-radius: 5px; cursor: pointer; opacity: 0.7;" onmouseover="this.style.opacity=1" onmouseout="this.style.opacity=0.7;">&lt;</button>
                        <button onclick="changeImage(1)" style="background-color: #4285f4; color: white; padding: 10px 20px; margin: auto; border: none; border-radius: 5px; cursor: pointer; opacity: 0.7;" onmouseover="this.style.opacity=1" onmouseout="this.style.opacity=0.7;">&gt;</button>
                    </div>
                </div>

                <p id="no-images-msg" style="color: #888; font-size: 18px; display: none;">No images found in the "shots" folder.</p>
            </div>

            <div id="table-body1" class="growthTable">
                <!-- Data table --><table border="1">
                    <thead>
                    <tr>
                        <th>DateTime</th>
                        <th>ChickNumber</th>
                        <th>Weight</th>
                    </tr>
                    </thead>
                    <tbody>
                    <!-- Table data will be dynamically loaded here --></tbody>
                </table>
            </div>

            <div id="table-body5" class="growthTable">
                <!-- Data table --><table border="1">
                    <thead>
                    <tr>
                        <th>DateTime</th>
                        <th>ChickNumber</th>
                        <th>Status</th>
                    </tr>
                    </thead>
                    <tbody>
                    <!-- Table data will be dynamically loaded here --></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ====== ionicons ======= --><script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
    <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>

    <!-- =========== Scripts =========  --><script src="{{ url_for('static', filename='js/main.js') }}"></script>

    <!-- =========== Combined Page Scripts =========  --><script>
        // --- Image Slider Script ---
        var currentImageIndex = 0;
        var imageFiles = [];
        var autoChangeInterval; // Variable to hold the interval ID

        // FIX: Get URL base from the data- attribute on the image-container
        const imageContainer = document.getElementById('image-container');
        const listUrl = imageContainer.dataset.listUrl;
        const staticShotsUrl = imageContainer.dataset.shotsUrl;


        function startAutoChange() {
            autoChangeInterval = setInterval(function () {
                fetchImageList();
                changeImage(1); // Change to the next photo
            }, 2000); // Check for updates every 2 seconds
        }

        function stopAutoChange() {
            clearInterval(autoChangeInterval); // Stop automatic photo changing
        }

        function fetchImageList() {
            // FIX: Use the 'listUrl' variable defined above
            fetch(listUrl) // Use the variable here
                .then(response => response.json())
                .then(data => {
                    if (JSON.stringify(data) !== JSON.stringify(imageFiles)) {
                        imageFiles = data;
                        // If image list changes, re-render immediately to show new images
                        if (imageFiles.length > 0) {
                            changeImage(0); // Display the first image in the new list
                            document.getElementById('no-images-msg').style.display = "none";
                        } else {
                            document.getElementById('current-image-1').src = "";
                            document.getElementById('current-image-2').src = "";
                            document.getElementById('current-image-3').src = "";
                            document.getElementById('no-images-msg').style.display = "block";
                        }
                    }
                })
                .catch(error => {
                    console.error("Error fetching image list:", error);
                    document.getElementById('no-images-msg').style.display = "block";
                });
        }

        function changeImage(offset) {
            if (imageFiles.length === 0) {
                document.getElementById('no-images-msg').style.display = "block";
                return;
            }
            
            currentImageIndex += offset;

            if (currentImageIndex < 0) {
                currentImageIndex = imageFiles.length - 1;
            } else if (currentImageIndex >= imageFiles.length) {
                currentImageIndex = 0;
            }

            // FIX: Use the 'staticShotsUrl' variable defined above
            document.getElementById('current-image-1').src = staticShotsUrl + imageFiles[currentImageIndex];
            document.getElementById('current-image-2').src = staticShotsUrl + imageFiles[(currentImageIndex + 1) % imageFiles.length];
            document.getElementById('current-image-3').src = staticShotsUrl + imageFiles[(currentImageIndex + 2) % imageFiles.length];
            document.getElementById('no-images-msg').style.display = "none";
        }

        // --- Toggles, Datetime, and Slider Start ---
        document.addEventListener('DOMContentLoaded', function() {
            // --- Real-time Date and Time Display ---
            // FIX: This now finds the span with this ID, which is in the main content area
            let dateTimeSpan = document.getElementById('displayDateTime'); 
            
            function updateDateTime() {
                if (dateTimeSpan) {
                    const now = new Date();
                    const options = {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    };
                    dateTimeSpan.textContent = now.toLocaleDateString('en-US', options);
                }
            }
            
            updateDateTime();
            setInterval(updateDateTime, 1000);

            // --- Notification Toggle (assuming this is in your main.js, but adding a fallback) ---
            let notifIcon = document.querySelector('.iconn');
            let notifBox = document.getElementById('box');

            if (notifIcon && notifBox) {
                // Check if toggleNotifi is already defined by main.js
                if (typeof toggleNotifi !== 'function') {
                    window.toggleNotifi = function() {
                        notifBox.classList.toggle('active'); // 'active' class probably controls display
                    }
                }
            }
            
            // --- Sidebar Toggle (assuming this is in your main.js) ---
            let toggle = document.querySelector('.toggle');
            let navigation = document.querySelector('.navigation');
            let main = document.querySelector('.main');

            if (toggle && navigation && main) {
                toggle.onclick = function() {
                    navigation.classList.toggle('active');
                    main.classList.toggle('active');
                }
            }

            // --- Start Image Slider ---
            // Fetch images first, then start the auto-change
            fetchImageList(); 
            startAutoChange();
        });
    </script>
</body>
</html>
